.. default-domain:: chpl

.. module:: MultiTypeSymEntry

MultiTypeSymEntry
=================
**Usage**

.. code-block:: chapel

   use MultiTypeSymEntry;


or

.. code-block:: chapel

   import MultiTypeSymEntry;

.. data:: const genLogger = new Logger(logLevel, logChannel)

.. enum:: enum SymbolEntryType { AbstractSymEntry, TypedArraySymEntry, PrimitiveTypedArraySymEntry, ComplexTypedArraySymEntry, GenSymEntry, SegStringSymEntry, CategoricalSymEntry, SegArraySymEntry, CompositeSymEntry, GroupBySymEntry, AnythingSymEntry, UnknownSymEntry, None }

   *
   * Internal Types we can use to build our Symbol type hierarchy.
   * We are making the types a little more concrete than using Strings
   


.. class:: AbstractSymEntry

   *
   * This is the root of our SymbolTable Entry / Typing system.
   * All other SymEntry classes should inherit from this class
   * or one of its ancestors and ultimately everything should
   * be assignable/coercible to this class.
   * 
   * All subclasses should set & add their type to the `assignableTypes`
   * set so we can maintain & determine the type hierarchy.
   


   .. attribute:: var entryType: SymbolEntryType

   .. attribute:: var assignableTypes: set(SymbolEntryType)

   .. attribute:: var name = ""

   .. method:: proc init()

   .. method:: proc init(input)

   .. method:: proc setName(name: string)

      
      Sets the name of the entry when it is added to the Symbol Table
      

   .. method:: proc isAssignableTo(entryType: SymbolEntryType): bool

      *
      * This can be used to help determine if a class can be
      * assigned / coerced / cast to another one in its hierarchy.
      

   .. method:: proc getSizeEstimate(): int

      *
      * This is a hook for the ServerConfig.overMemLimit procedure
      * All concrete classes should override this method
      

   .. method:: proc __str__(thresh: int = 1, prefix: string = "", suffix: string = "", baseFormat: string = ""): string throws

      *
      * Formats and returns data in this entry up to the specified threshold. 
      * Arrays of size less than threshold will be printed in their entirety. 
      * Arrays of size greater than or equal to threshold will print the first 3 and last 3 elements
      *
      * :arg thresh: threshold for data to return
      * :type thresh: int
      *
      * :arg prefix: String to prepend to the front of the data string
      * :type prefix: string
      *
      * :arg suffix: String to append to the tail of the data string
      * :type suffix: string
      *
      * :arg baseFormat: String which represents the base format string for the data type
      * :type baseFormat: string
      *
      * :returns: s (string) containing the array data
      

.. function:: proc toSymEntry(gse: borrowed GenSymEntry, type etype)

   Casts a GenSymEntry to the specified type and returns it.
   
   :arg gse: generic sym entry
   :type gse: borrowed GenSymEntry
   
    :arg etype: type for gse to be cast to
    :type etype: type
   

.. class:: GenSymEntry : AbstractSymEntry

    
   This is a dummy class to avoid having to talk about specific
   instantiations of SymEntry. 
   GenSymEntries can contain multiple SymEntries, but they represent a singular object.
   For example, SegArray contains the offsets and values array, but only the values are 
   considered data.
   


   .. attribute:: var dtype: DType

   .. attribute:: var itemsize: int

   .. attribute:: var size: int = 0

   .. attribute:: var ndim: int = 1

   .. attribute:: var shape: 1*(int) = (0,)

   .. method:: proc init(type etype, len: int = 0)

   .. method:: override proc getSizeEstimate(): int

   .. method:: proc toSymEntry(type etype)

      Cast this `GenSymEntry` to `borrowed SymEntry(etype)`
      
      This function will halt if the cast fails.
      
      :arg etype: `SymEntry` type parameter
      :type etype: type
      

   .. method:: override proc __str__(thresh: int = 1, prefix: string = "", suffix: string = "", baseFormat: string = ""): string throws

       
      Formats and returns data in this entry up to the specified threshold. 
      Arrays of size less than threshold will be printed in their entirety. 
      Arrays of size greater than or equal to threshold will print the first 3 and last 3 elements
      
        :arg thresh: threshold for data to return
        :type thresh: int
      
        :arg prefix: String to prepend to the front of the data string
        :type prefix: string
      
        :arg suffix: String to append to the tail of the data string
        :type suffix: string
      
        :arg baseFormat: String which represents the base format string for the data type
        :type baseFormat: string
      
        :returns: s (string) containing the array data
      

.. class:: SymEntry : GenSymEntry

   Symbol table entry
   Only supports 1-d arrays for now 


   .. attribute:: type etype

      
      generic element type array
      etype is different from dtype (chapel vs numpy)
      

   .. attribute:: var a = makeDistArray(size, etype)

      
      'a' is the distributed array whose value and type are defined by
      makeDist{Dom,Array}() to support varying distributions
      

   .. method:: proc aD

      Removed domain accessor, use `a.domain` instead 

   .. attribute:: var max_bits = -1

      only used with bigint pdarrays 

   .. method:: proc init(len: int, type etype)

      
      This init takes length and element type
      
      :arg len: length of array to be allocated
      :type len: int
      
      :arg etype: type to be instantiated
      :type etype: type
      

   .. method:: proc init(in a: [?D] ?etype, max_bits = -1)

      
      This init takes an array whose type matches `makeDistArray()`
      
      :arg a: array
      :type a: [] ?etype
      

   .. method:: proc init(a: [?D] ?etype)

      
      This init takes an array whose type is defaultRectangular (convenience
      function for creating a distributed array from a non-distributed one)
      
      :arg a: array
      :type a: [] ?etype
      

   .. method:: proc deinit()

      
      Verbose flag utility method
      

   .. method:: override proc writeThis(f) throws

   .. method:: override proc __str__(thresh: int = 6, prefix: string = "[", suffix: string = "]", baseFormat: string = "%t"): string throws

      
      Formats and returns data in this entry up to the specified threshold. 
      Arrays of size less than threshold will be printed in their entirety. 
      Arrays of size greater than or equal to threshold will print the first 3 and last 3 elements
      
          :arg thresh: threshold for data to return
          :type thresh: int
      
          :arg prefix: String to pre-pend to the front of the data string
          :type prefix: string
      
          :arg suffix: String to append to the tail of the data string
          :type suffix: string
      
          :arg baseFormat: String which represents the base format string for the data type
          :type baseFormat: string
      
          :returns: s (string) containing the array data
      

.. class:: CompositeSymEntry : AbstractSymEntry

   
   Base class for any entry that consists of multiple SymEntries that have varying types.
   These entries are related, but do not represent a single object.
   For Example, group by contains multiple SymEntries that are all considered part of the dataset.
   


   .. attribute:: var ndim: int = 1

   .. attribute:: var size: int = 0

   .. method:: proc init(len: int = 0)

.. function:: proc createTypedSymEntry(len: int, type t) throws

   *
   * Factory method for creating a typed SymEntry and checking mem limits
   * :arg len: the number of elements to allocate
   * :type len: int
   * 
   * :arg t: the element type
   * :type t: type
   

.. class:: SegStringSymEntry : GenSymEntry

   .. attribute:: type etype = string

   .. attribute:: var offsetsEntry: shared SymEntry(int)

   .. attribute:: var bytesEntry: shared SymEntry(uint(8))

   .. method:: proc init(offsetsSymEntry: shared SymEntry, bytesSymEntry: shared SymEntry, type etype)

   .. method:: override proc getSizeEstimate(): int

   .. method:: override proc __str__(thresh: int = 1, prefix: string = "", suffix: string = "", baseFormat: string = ""): string throws

      *
      * Formats and returns data in this entry up to the specified threshold. 
      * Arrays of size less than threshold will be printed in their entirety. 
      * Arrays of size greater than or equal to threshold will print the first 3 and last 3 elements
      *
      * :arg thresh: threshold for data to return
      * :type thresh: int
      *
      * :arg prefix: String to prepend to the front of the data string
      * :type prefix: string
      *
      * :arg suffix: String to append to the tail of the data string
      * :type suffix: string
      *
      * :arg baseFormat: String which represents the base format string for the data type
      * :type baseFormat: string
      *
      * :returns: s (string) containing the array data
      

.. class:: SegArraySymEntry : GenSymEntry

   .. attribute:: type etype

   .. attribute:: var segmentsEntry: shared SymEntry(int)

   .. attribute:: var valuesEntry: shared SymEntry(etype)

   .. attribute:: var lengthsEntry: shared SymEntry(int)

   .. method:: proc init(segmentsSymEntry: shared SymEntry, valuesSymEntry: shared SymEntry, type etype)

   .. method:: override proc getSizeEstimate(): int

.. class:: GroupBySymEntry : CompositeSymEntry

   
   Symbol Table entry representing a GroupBy object.
   


   .. attribute:: var keyNamesEntry: shared SymEntry(string)

   .. attribute:: var keyTypesEntry: shared SymEntry(string)

   .. attribute:: var segmentsEntry: shared SymEntry(int)

   .. attribute:: var permEntry: shared SymEntry(int)

   .. attribute:: var ukIndEntry: shared SymEntry(int)

   .. method:: proc init(keyNamesEntry: shared SymEntry, keyTypesEntry: shared SymEntry, segmentsSymEntry: shared SymEntry, permSymEntry: shared SymEntry, ukIndSymEntry: shared SymEntry, itemsize: int)

   .. method:: override proc getSizeEstimate(): int

.. function:: proc toGenSymEntry(entry: borrowed AbstractSymEntry) throws

   *
   * Helper proc to cast AbstrcatSymEntry to GenSymEntry
   

.. function:: proc toCompositeSymEntry(entry: borrowed AbstractSymEntry) throws

   *
   * Helper proc to cast AbstractSymEntry to CompositeSymEntry
   

.. function:: proc toSegStringSymEntry(entry: borrowed AbstractSymEntry) throws

   *
   * Helper proc to cast AbstractSymEntry to SegStringSymEntry
   

.. function:: proc toSegArraySymEntry(entry: borrowed AbstractSymEntry, type t) throws

.. function:: proc getArraySpecFromEntry(entry: borrowed AbstractSymEntry) throws

   *
   * Temporary shim to ease transition to Typed Symbol Table Entries.
   * This attempts to retrieve the Dtype, size/array-length, and itemsize from a SymbolTable
   * entry if the entry type supports it. Returns default tuple of valuse otherwise.
   * 
   * :arg entry: AbstractSymEntry or descendant
   * :type entry: borrowed AbstractSymEntry
   * :retruns: tuple of (dtype, entry.size, entry.itemsize)
   * 
   * Note: entry.size is generally the number of elements in the array
   *       and is more synonymous with length
   

